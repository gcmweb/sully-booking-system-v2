"use strict";(()=>{var e={};e.id=6760,e.ids=[6760],e.modules={53524:e=>{e.exports=require("@prisma/client")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},61282:e=>{e.exports=require("child_process")},84770:e=>{e.exports=require("crypto")},17702:e=>{e.exports=require("events")},32615:e=>{e.exports=require("http")},35240:e=>{e.exports=require("https")},21764:e=>{e.exports=require("util")},17178:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>v,patchFetch:()=>k,requestAsyncStorage:()=>g,routeModule:()=>E,serverHooks:()=>P,staticGenerationAsyncStorage:()=>I});var i={};r.r(i),r.d(i,{POST:()=>b,dynamic:()=>l});var o=r(49303),s=r(88716),n=r(60670),a=r(87070),c=r(7035),u=r(67636),p=r(53524),d=r(9487);let l="force-dynamic";async function b(e){try{let t;let r=(0,c.oV)();if(!r.valid)return console.error("❌ Stripe configuration errors in webhook:",r.errors),a.NextResponse.json({error:"Payment system configuration error"},{status:500});let i=await e.text(),o=e.headers.get("stripe-signature");if(!o)return console.error("❌ No Stripe signature provided"),a.NextResponse.json({error:"No signature"},{status:400});let s=process.env.STRIPE_WEBHOOK_SECRET;try{t=await (0,c.MP)(i,o,s)}catch(e){return console.error("Webhook signature verification failed:",e),a.NextResponse.json({error:"Invalid signature"},{status:400})}switch(console.log("Received webhook event:",t.type),t.type){case"checkout.session.completed":await m(t.data.object);break;case"customer.subscription.created":await f(t.data.object);break;case"customer.subscription.updated":await h(t.data.object);break;case"customer.subscription.deleted":await w(t.data.object);break;case"invoice.payment_succeeded":await y(t.data.object);break;case"invoice.payment_failed":await S(t.data.object);break;default:console.log(`Unhandled event type: ${t.type}`)}return a.NextResponse.json({received:!0})}catch(e){return console.error("Webhook error:",e),a.NextResponse.json({error:"Webhook handler failed"},{status:500})}}async function m(e){try{let t=e.metadata?.userId,r=e.metadata?.targetPlan;if(!t||!r){console.error("Missing metadata in checkout session:",e.id);return}console.log(`Checkout completed for user ${t}, plan: ${r}`)}catch(e){console.error("Error handling checkout completed:",e)}}async function f(e){try{let t=e.customer,r=await d._.subscription.findFirst({where:{stripeCustomerId:t},include:{venue:{include:{owner:!0}}}});if(!r){console.error("No subscription found for customer:",t);return}let i=r.venue.ownerId,o=_(e.items.data[0].price.id);await (0,u.tw)(i,o,e.id),console.log(`Subscription created for user ${i}, plan: ${o}`)}catch(e){console.error("Error handling subscription created:",e)}}async function h(e){try{let t=_(e.items.data[0].price.id),r=await d._.subscription.findFirst({where:{stripeSubscriptionId:e.id},include:{venue:!0}});if(!r){console.error("No subscription found for Stripe subscription:",e.id);return}let i=r.venue.ownerId,o=p.SubscriptionStatus.ACTIVE;"canceled"===e.status?o=p.SubscriptionStatus.CANCELLED:"past_due"===e.status?o=p.SubscriptionStatus.PAST_DUE:"unpaid"===e.status&&(o=p.SubscriptionStatus.UNPAID),await d._.subscription.update({where:{id:r.id},data:{plan:t,status:o,currentPeriodStart:new Date(1e3*e.current_period_start),currentPeriodEnd:new Date(1e3*e.current_period_end),bookingsLimit:t===p.SubscriptionPlan.FREE?50:null}}),console.log(`Subscription updated for user ${i}, plan: ${t}, status: ${o}`)}catch(e){console.error("Error handling subscription updated:",e)}}async function w(e){try{let t=await d._.subscription.findFirst({where:{stripeSubscriptionId:e.id},include:{venue:!0}});if(!t){console.error("No subscription found for Stripe subscription:",e.id);return}let r=t.venue.ownerId;await (0,u.tw)(r,p.SubscriptionPlan.FREE),await d._.subscription.update({where:{id:t.id},data:{status:p.SubscriptionStatus.CANCELLED,stripeSubscriptionId:null}}),console.log(`Subscription deleted for user ${r}, downgraded to FREE`)}catch(e){console.error("Error handling subscription deleted:",e)}}async function y(e){try{let t=e.subscription;if(!t)return;let r=await d._.subscription.findFirst({where:{stripeSubscriptionId:t}});if(!r){console.error("No subscription found for Stripe subscription:",t);return}await d._.subscription.update({where:{id:r.id},data:{status:p.SubscriptionStatus.ACTIVE,bookingsUsed:0}}),await d._.payment.create({data:{subscriptionId:r.id,amount:e.amount_paid/100,currency:e.currency.toUpperCase(),status:"COMPLETED",provider:"STRIPE",providerPaymentId:e.payment_intent,metadata:{invoiceId:e.id,subscriptionId:t}}}),console.log(`Payment succeeded for subscription ${t}`)}catch(e){console.error("Error handling payment succeeded:",e)}}async function S(e){try{let t=e.subscription;if(!t)return;let r=await d._.subscription.findFirst({where:{stripeSubscriptionId:t}});if(!r){console.error("No subscription found for Stripe subscription:",t);return}await d._.subscription.update({where:{id:r.id},data:{status:p.SubscriptionStatus.PAST_DUE}}),await d._.payment.create({data:{subscriptionId:r.id,amount:e.amount_due/100,currency:e.currency.toUpperCase(),status:"FAILED",provider:"STRIPE",providerPaymentId:e.payment_intent,metadata:{invoiceId:e.id,subscriptionId:t,failureReason:e.last_payment_error?.message}}}),console.log(`Payment failed for subscription ${t}`)}catch(e){console.error("Error handling payment failed:",e)}}function _(e){return({[process.env.STRIPE_PAID_PRICE_ID||"price_paid_mock"]:p.SubscriptionPlan.PAID,[process.env.STRIPE_PREMIUM_PRICE_ID||"price_premium_mock"]:p.SubscriptionPlan.PREMIUM})[e]||p.SubscriptionPlan.FREE}let E=new o.AppRouteRouteModule({definition:{kind:s.x.APP_ROUTE,page:"/api/subscriptions/webhook/route",pathname:"/api/subscriptions/webhook",filename:"route",bundlePath:"app/api/subscriptions/webhook/route"},resolvedPagePath:"/home/ubuntu/sully-booking-system/app/app/api/subscriptions/webhook/route.ts",nextConfigOutput:"standalone",userland:i}),{requestAsyncStorage:g,staticGenerationAsyncStorage:I,serverHooks:P}=E,v="/api/subscriptions/webhook/route";function k(){return(0,n.patchFetch)({serverHooks:P,staticGenerationAsyncStorage:I})}}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),i=t.X(0,[9276,5972,1059,7636],()=>r(17178));module.exports=i})();