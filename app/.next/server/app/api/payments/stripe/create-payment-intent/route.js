"use strict";(()=>{var e={};e.id=3390,e.ids=[3390],e.modules={53524:e=>{e.exports=require("@prisma/client")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},61282:e=>{e.exports=require("child_process")},84770:e=>{e.exports=require("crypto")},17702:e=>{e.exports=require("events")},32615:e=>{e.exports=require("http")},35240:e=>{e.exports=require("https")},21764:e=>{e.exports=require("util")},28633:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>y,patchFetch:()=>I,requestAsyncStorage:()=>m,routeModule:()=>l,serverHooks:()=>E,staticGenerationAsyncStorage:()=>_});var n={};r.r(n),r.d(n,{POST:()=>d,dynamic:()=>p});var o=r(49303),s=r(88716),a=r(60670),i=r(87070),c=r(9487),u=r(7035);let p="force-dynamic";async function d(e){try{let t=(0,u.oV)();if(!t.valid)return console.error("Stripe configuration errors:",t.errors),i.NextResponse.json({error:"Payment system configuration error",details:"Please contact support"},{status:500});let{bookingId:r,amount:n,currency:o="gbp"}=await e.json();if(!r||!n)return i.NextResponse.json({error:"Booking ID and amount are required"},{status:400});if(n<=0)return i.NextResponse.json({error:"Amount must be greater than 0"},{status:400});let s=await c._.booking.findUnique({where:{id:r},include:{venue:{select:{name:!0,ownerId:!0}},customer:{select:{email:!0,firstName:!0,lastName:!0}}}});if(!s)return i.NextResponse.json({error:"Booking not found"},{status:404});if(await c._.payment.findFirst({where:{bookingId:r,status:{in:["PENDING","COMPLETED"]}}}))return i.NextResponse.json({error:"Payment already exists for this booking"},{status:400});let a=await (0,u.Gl)(n,o,{bookingId:r,venueId:s.venueId,venueName:s.venue.name,customerEmail:s.customer?.email||"guest",customerName:s.customer?`${s.customer.firstName} ${s.customer.lastName}`:"Guest",bookingDate:s.date.toISOString(),bookingTime:s.time,source:"sully_booking_system"}),p=await c._.payment.create({data:{bookingId:r,amount:n,currency:o.toUpperCase(),status:"PENDING",provider:"STRIPE",providerPaymentId:a.id,metadata:{paymentIntentId:a.id,clientSecret:a.client_secret,venueName:s.venue.name,customerEmail:s.customer?.email,createdAt:new Date().toISOString()}}});return console.log(`✅ Payment intent created for booking ${r}, amount: ${n} ${o.toUpperCase()}`),i.NextResponse.json({paymentIntent:{id:a.id,client_secret:a.client_secret,amount:a.amount,currency:a.currency,status:a.status},payment:{id:p.id,status:p.status,amount:p.amount,currency:p.currency},booking:{id:s.id,venueName:s.venue.name,date:s.date,time:s.time}})}catch(t){console.error("Create payment intent error:",t);let e=t instanceof Error?t.message:"Failed to create payment intent";return i.NextResponse.json({error:e,timestamp:new Date().toISOString()},{status:500})}}let l=new o.AppRouteRouteModule({definition:{kind:s.x.APP_ROUTE,page:"/api/payments/stripe/create-payment-intent/route",pathname:"/api/payments/stripe/create-payment-intent",filename:"route",bundlePath:"app/api/payments/stripe/create-payment-intent/route"},resolvedPagePath:"/home/ubuntu/sully-booking-system/app/app/api/payments/stripe/create-payment-intent/route.ts",nextConfigOutput:"standalone",userland:n}),{requestAsyncStorage:m,staticGenerationAsyncStorage:_,serverHooks:E}=l,y="/api/payments/stripe/create-payment-intent/route";function I(){return(0,a.patchFetch)({serverHooks:E,staticGenerationAsyncStorage:_})}},9487:(e,t,r)=>{r.d(t,{_:()=>o});var n=r(53524);let o=globalThis.prisma??new n.PrismaClient},7035:(e,t,r)=>{let n;r.d(t,{EO:()=>y,Eu:()=>l,Gl:()=>m,MP:()=>_,Mc:()=>d,RD:()=>I,Sh:()=>p,oV:()=>i,rg:()=>c,updateSubscription:()=>E});var o=r(31059);try{let e=process.env.STRIPE_SECRET_KEY;if(!e)throw Error("STRIPE_SECRET_KEY environment variable is required");e.startsWith("sk_test_")&&"test"!==process.env.STRIPE_MODE&&console.warn("⚠️  WARNING: Using test Stripe keys in production environment"),n=new o.Z(e,{apiVersion:"2025-05-28.basil",typescript:!0,telemetry:!1})}catch(e){throw console.error("❌ Failed to initialize Stripe:",e),e}let s=()=>{let e=process.env.STRIPE_SECRET_KEY,t=process.env.STRIPE_MODE;return"live"===t||"test"!==t&&(e?.startsWith("sk_live_")||!1)},a=()=>{let e=process.env.STRIPE_SECRET_KEY;return!e||"sk_test_mock_key"===e||"sk_test_mock_key_for_demo"===e||e.includes("mock")},i=()=>{let e=[];return process.env.STRIPE_SECRET_KEY||e.push("STRIPE_SECRET_KEY is required"),process.env.STRIPE_PUBLISHABLE_KEY||e.push("STRIPE_PUBLISHABLE_KEY is required"),process.env.STRIPE_WEBHOOK_SECRET||e.push("STRIPE_WEBHOOK_SECRET is required for webhook security"),s()||a()||(process.env.STRIPE_PAID_PRICE_ID||e.push("STRIPE_PAID_PRICE_ID is required"),process.env.STRIPE_PREMIUM_PRICE_ID||e.push("STRIPE_PREMIUM_PRICE_ID is required")),{valid:0===e.length,errors:e}},c={PAID:process.env.STRIPE_PAID_PRICE_ID||(a()?"price_paid_mock":void 0),PREMIUM:process.env.STRIPE_PREMIUM_PRICE_ID||(a()?"price_premium_mock":void 0)};async function u(e,t){try{return await e()}catch(e){if(console.error(`Stripe Error - ${t}:`,e),e instanceof o.Z.errors.StripeError)switch(console.error("Stripe Error Details:",{type:e.type,code:e.code,message:e.message,statusCode:e.statusCode}),e.type){case"StripeCardError":throw Error("Your card was declined. Please try a different payment method.");case"StripeRateLimitError":throw Error("Too many requests. Please try again in a moment.");case"StripeInvalidRequestError":throw Error("Invalid request. Please contact support if this continues.");case"StripeAPIError":throw Error("Payment service temporarily unavailable. Please try again.");case"StripeConnectionError":throw Error("Network error. Please check your connection and try again.");case"StripeAuthenticationError":throw Error("Authentication failed. Please contact support.");default:throw Error("Payment processing failed. Please try again or contact support.")}throw Error(t)}}async function p(e,t,r){return a()?{id:`cus_demo_${Date.now()}`,email:e,name:t,metadata:{source:"sully_booking_system",demo:"true",...r},object:"customer",balance:0,created:Math.floor(Date.now()/1e3),default_source:null,delinquent:!1,description:null,discount:null,invoice_prefix:null,invoice_settings:{custom_fields:null,default_payment_method:null,footer:null,rendering_options:null},livemode:!1,next_invoice_sequence:1,phone:null,preferred_locales:[],shipping:null,tax_exempt:"none",test_clock:null}:u(async()=>await n.customers.create({email:e,name:t,metadata:{source:"sully_booking_system",created_at:new Date().toISOString(),...r}}),"Failed to create customer")}async function d(e,t,r,o,s){if(a()){let n=`cs_demo_${Date.now()}`;return{id:n,url:`${r}?session_id=${n}&demo=true&price_id=${t}`,customer:e,metadata:s||{},mode:"subscription",success_url:r,cancel_url:o}}return u(async()=>await n.checkout.sessions.create({customer:e,payment_method_types:["card"],line_items:[{price:t,quantity:1}],mode:"subscription",success_url:r,cancel_url:o,allow_promotion_codes:!0,billing_address_collection:"auto",customer_update:{name:"auto",address:"auto"},metadata:{created_at:new Date().toISOString(),...s},subscription_data:{metadata:s||{}}}),"Failed to create checkout session")}async function l(e,t){return a()?{id:`bps_demo_${Date.now()}`,url:`${t}?billing_portal=demo&customer=${e}`,customer:e,return_url:t}:u(async()=>await n.billingPortal.sessions.create({customer:e,return_url:t,flow_data:{type:"subscription_update_confirm",subscription_update_confirm:{subscription:e,items:[]}}}),"Failed to create billing portal session")}async function m(e,t="gbp",r){return a()?{id:`pi_demo_${Date.now()}`,client_secret:`pi_demo_${Date.now()}_secret_${Math.random().toString(36).substr(2,9)}`,amount:Math.round(100*e),currency:t,status:"requires_payment_method",metadata:r||{}}:u(async()=>await n.paymentIntents.create({amount:Math.round(100*e),currency:t.toLowerCase(),automatic_payment_methods:{enabled:!0},metadata:{created_at:new Date().toISOString(),...r}}),"Failed to create payment intent")}async function _(e,t,r){let o=r||process.env.STRIPE_WEBHOOK_SECRET;if(!o)throw Error("Webhook secret is required for security");if(a())try{return JSON.parse(e)}catch(e){throw Error("Invalid webhook payload")}return u(async()=>n.webhooks.constructEvent(e,t,o),"Invalid webhook signature")}async function E(e,t){return a()?{id:e,customer:"cus_demo",status:"active",items:{data:[{id:`si_demo_${Date.now()}`,price:{id:t}}]}}:u(async()=>{let r=await n.subscriptions.retrieve(e);return await n.subscriptions.update(e,{items:[{id:r.items.data[0].id,price:t}],proration_behavior:"create_prorations"})},"Failed to update subscription")}async function y(e){return a()?{id:e,status:"canceled",cancel_at_period_end:!0}:u(async()=>await n.subscriptions.update(e,{cancel_at_period_end:!0}),"Failed to cancel subscription")}function I(){return{isLiveMode:s(),isDemoMode:a(),publishableKey:process.env.STRIPE_PUBLISHABLE_KEY,priceIds:c,validation:i()}}c.PAID,c.PREMIUM}};var t=require("../../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),n=t.X(0,[9276,5972,1059],()=>r(28633));module.exports=n})();